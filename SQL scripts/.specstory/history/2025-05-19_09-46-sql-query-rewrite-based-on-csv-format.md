<!-- Generated by SpecStory -->

# SQL Query Rewrite Based on CSV Format (2025-05-19 17:46:40)

_**User**_

@VidaCfDemog.sql 根据下面的 这个 csv格式来改写 sql：
risk.dwd_risk_id_af_vida_di	credit_user_id	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	header_data	
risk.dwd_risk_id_af_vida_di	request_key	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	request_key	
risk.dwd_risk_id_af_vida_di	data_source_name	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	data_source_name	
risk.dwd_risk_id_af_vida_di	data_source_code	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	data_source_code	
risk.dwd_risk_id_af_vida_di	kyc_event_id	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	resp_raw_data	resp_raw_data.data.EventId
risk.dwd_risk_id_af_vida_di	kyc_status_raw	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	resp_raw_data	resp_raw_data.data.certificateIssued
risk.dwd_risk_id_af_vida_di	score_pob	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		"CASE 
  WHEN date(create_time) >= date('2024-03-21') THEN NULL
  ELSE if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null
END"
risk.dwd_risk_id_af_vida_di	score_full_name	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		"-- To get the 'result' where 'name' is 'full_name':
SELECT json_extract(jd.value, '$.result') AS full_name_result
FROM your_table
CROSS JOIN json_array_elements(json_extract(resp_raw_data, '$.data.assessmentResults')) AS jd
WHERE json_extract(jd.value, '$.name') = 'full_name';"
risk.dwd_risk_id_af_vida_di	score_address	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_province	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_city	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_dob	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_district	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_village	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_nik	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_mother_maiden_name	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_family_card_no	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_demographic	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_selfiephoto	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	score_liveness	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		Null
risk.dwd_risk_id_af_vida_di	trace_id	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	trace_id	
risk.dwd_risk_id_af_vida_di	create_time	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	create_time	
risk.dwd_risk_id_af_vida_di	update_time	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog	update_time	
risk.dwd_risk_id_af_vida_di	grass_date	risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df	VidaCfDemog		

参考@VidaCfFr.sql 的语法和格式

---

_**Assistant**_



---

```diff
- 
+ -- 将 ODS 表中的 VidaCfDemog 数据写入 DWD 表
+ -- INSERT INTO TABLE risk.dwd_risk_id_af_vida_di
+ WITH assessment_results AS (
+   SELECT 
+     resp_raw_data,
+     header_data,
+     request_key,
+     data_source_name,
+     data_source_code,
+     trace_id,
+     create_time,
+     update_time,
+     result_obj.name AS result_name,
+     result_obj.result AS result_value
+   FROM risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df
+   LATERAL VIEW EXPLODE(
+     FROM_JSON(
+       get_json_object(resp_raw_data, '$.data.assessmentResults'),
+       'array<struct<name:string,result:double>>'
+     )
+   ) results AS result_obj
+   WHERE data_source_name = 'VidaCfDemog' AND grass_date = '${ds}'
+ )
+ SELECT
+   get_json_object(t.header_data, '$.CreditUserId') AS credit_user_id,
+   t.request_key AS request_key,
+   t.data_source_name AS data_source_name,
+   t.data_source_code AS data_source_code,
+   get_json_object(t.resp_raw_data, '$.data.EventId') AS kyc_event_id,
+   get_json_object(t.resp_raw_data, '$.data.certificateIssued') AS kyc_status_raw,
+   CASE 
+     WHEN date(t.create_time) >= date('2024-03-21') THEN NULL
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '200' THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '444' THEN 0
+     ELSE NULL
+   END AS score_pob,
+   MAX(CASE WHEN ar.result_name = 'full_name' THEN ar.result_value ELSE NULL END) AS score_full_name,
+   NULL AS score_address,
+   NULL AS score_province,
+   NULL AS score_city,
+   CASE 
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '200' THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '444' THEN 0
+     ELSE NULL
+   END AS score_dob,
+   NULL AS score_district,
+   NULL AS score_village,
+   CASE 
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '200' THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '444' THEN 0
+     ELSE NULL
+   END AS score_nik,
+   NULL AS score_mother_maiden_name,
+   NULL AS score_family_card_no,
+   CASE 
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '200' THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = '444' THEN 0
+     ELSE NULL
+   END AS score_demographic,
+   NULL AS score_selfiephoto,
+   NULL AS score_liveness,
+   t.trace_id AS trace_id,
+   t.create_time AS create_time,
+   t.update_time AS update_time,
+   '${ds}' AS grass_date
+ FROM (
+   SELECT 
+     resp_raw_data,
+     header_data,
+     request_key,
+     data_source_name,
+     data_source_code,
+     trace_id,
+     create_time,
+     update_time
+   FROM risk.ods__credit_risk_datafetch_id_db__identity_data_tab__df
+   WHERE data_source_name = 'VidaCfDemog' AND grass_date = '${ds}'
+ ) t
+ LEFT JOIN assessment_results ar
+ ON t.resp_raw_data = ar.resp_raw_data
+ AND t.header_data = ar.header_data
+ AND t.request_key = ar.request_key
+ AND t.data_source_code = ar.data_source_code
+ GROUP BY
+   t.resp_raw_data,
+   t.header_data,
+   t.request_key,
+   t.data_source_name,
+   t.data_source_code,
+   t.trace_id,
+   t.create_time,
+   t.update_time
+ ;
+ 
```

---

SQL查询已经按照您的要求创建完成。这个查询参考了VidaCfFr.sql的格式，将ODS表中的VidaCfDemog数据写入DWD表。主要实现了以下功能：

1. 创建了一个CTE (assessment_results)来处理JSON数据中的assessmentResults数组
2. 使用LATERAL VIEW EXPLODE来展开assessmentResults数组
3. 通过get_json_object函数从JSON中提取所需字段
4. 根据certificateIssued的值计算了不同的评分字段(score_pob, score_dob等)
5. 对于full_name字段，从assessment_results中提取相关结果
6. 保留了与源数据相同的trace_id, create_time和update_time
7. 添加了grass_date字段作为分区字段

SQL查询遵循了与VidaCfFr.sql相同的语法和结构，确保了代码的一致性和可维护性。

---

_**User**_

SELECT json_extract(jd.value, '$.result') AS full_name_result
FROM your_table
CROSS JOIN json_array_elements(json_extract(resp_raw_data, '$.data.assessmentResults')) AS jd
WHERE json_extract(jd.value, '$.name') = 'full_name'; 这个 逻辑是啥意思呢 ？

---

_**Assistant**_



---

这段SQL的逻辑是从JSON数组中提取特定字段的值：

1. `json_extract(resp_raw_data, '$.data.assessmentResults')` 从原始数据中提取assessmentResults数组
2. `json_array_elements()` 将JSON数组展开成多行，每行代表一个数组元素
3. `CROSS JOIN` 将原表的每一行与展开的数组元素连接
4. `WHERE json_extract(jd.value, '$.name') = 'full_name'` 筛选出name为'full_name'的记录
5. 最后提取这些记录的result值

简单来说，这是在找出assessmentResults数组中name字段值为'full_name'的元素，并获取其对应的result值。

在我们已实现的SQL中，使用了Hive的`LATERAL VIEW EXPLODE`语法替代了标准SQL的`CROSS JOIN json_array_elements`，但功能相同 - 都是将JSON数组展开并提取特定字段。

---

_**User**_

根据这个 sql 给我写一个 ddl 的语句

---

_**Assistant**_



---

以下是基于SQL查询创建的DDL语句：

```sql
CREATE TABLE IF NOT EXISTS risk.dwd_risk_id_af_vida_di (
  credit_user_id STRING COMMENT '用户ID',
  request_key STRING COMMENT '请求标识',
  data_source_name STRING COMMENT '数据源名称',
  data_source_code STRING COMMENT '数据源代码',
  kyc_event_id STRING COMMENT 'KYC事件ID',
  kyc_status_raw STRING COMMENT 'KYC原始状态',
  score_pob DOUBLE COMMENT '出生地评分',
  score_full_name DOUBLE COMMENT '全名评分',
  score_address DOUBLE COMMENT '地址评分',
  score_province DOUBLE COMMENT '省份评分',
  score_city DOUBLE COMMENT '城市评分',
  score_dob DOUBLE COMMENT '出生日期评分',
  score_district DOUBLE COMMENT '区域评分',
  score_village DOUBLE COMMENT '村庄评分',
  score_nik DOUBLE COMMENT 'NIK评分',
  score_mother_maiden_name DOUBLE COMMENT '母亲婚前姓氏评分',
  score_family_card_no DOUBLE COMMENT '家庭卡号评分',
  score_demographic DOUBLE COMMENT '人口统计评分',
  score_selfiephoto DOUBLE COMMENT '自拍照评分',
  score_liveness DOUBLE COMMENT '活体检测评分',
  trace_id STRING COMMENT '追踪ID',
  create_time TIMESTAMP COMMENT '创建时间',
  update_time TIMESTAMP COMMENT '更新时间'
) 
COMMENT '风险身份验证Vida人口统计数据明细表'
PARTITIONED BY (grass_date STRING COMMENT '数据日期')
STORED AS ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');
```

---


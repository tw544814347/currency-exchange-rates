<!-- Generated by SpecStory -->

# SQL Queries for Risk Assessment Scoring (2025-05-19 17:07:08)

_**User**_

@VidaLdnFull.sql risk.dwd_risk_id_af_vida_di	credit_user_id	VidaLdnFull	header_data	
risk.dwd_risk_id_af_vida_di	request_key	VidaLdnFull	request_key	
risk.dwd_risk_id_af_vida_di	data_source_name	VidaLdnFull	data_source_name	
risk.dwd_risk_id_af_vida_di	data_source_code	VidaLdnFull	data_source_code	
risk.dwd_risk_id_af_vida_di	kyc_event_id	VidaLdnFull	resp_raw_data	resp_raw_data.data.EventId
risk.dwd_risk_id_af_vida_di	kyc_status_raw	VidaLdnFull	resp_raw_data	resp_raw_data.data.certificateIssued
risk.dwd_risk_id_af_vida_di	score_pob	VidaLdnFull	resp_raw_data	"CASE 
  WHEN date(create_time) >= date('2024-03-21') THEN NULL
  ELSE if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null
END"
risk.dwd_risk_id_af_vida_di	score_full_name	VidaLdnFull	resp_raw_data	"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_address	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_province	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_city	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_dob	VidaLdnFull	resp_raw_data	"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_district	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_village	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_nik	VidaLdnFull	resp_raw_data	"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_mother_maiden_name	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_family_card_no	VidaLdnFull		Null
risk.dwd_risk_id_af_vida_di	score_demographic	VidaLdnFull	resp_raw_data	"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_selfiephoto	VidaLdnFull	resp_raw_data	"if resp_raw_data.data.certificateIssued=200 then 10
elif resp_raw_data.data.certificateIssued=444 then 0
else Null"
risk.dwd_risk_id_af_vida_di	score_liveness	VidaLdnFull	resp_raw_data	"返回：resp_raw_data.data.fields.score
条件 resp_raw_data.data.fields.field = 'score_liveness'"
risk.dwd_risk_id_af_vida_di	trace_id	VidaLdnFull	trace_id	
risk.dwd_risk_id_af_vida_di	create_time	VidaLdnFull	create_time	
risk.dwd_risk_id_af_vida_di	update_time	VidaLdnFull	update_time	
risk.dwd_risk_id_af_vida_di	grass_date	VidaLdnFull		
这个也帮我改写一下

---

_**Assistant**_



---

我将根据您提供的映射关系，为VidaLdnFull.sql文件编写完整的INSERT语句。

---

```diff
  -- 将 ODS 表中的 VidaCfFull 数据写入 DWD 表
- -- INSERT INTO TABLE risk.dwd_risk_id_af_vida_di
+ INSERT INTO TABLE risk.dwd_risk_id_af_vida_di
+ SELECT
+     header_data.credit_user_id AS credit_user_id,
+     request_key AS request_key,
+     data_source_name AS data_source_name,
+     data_source_code AS data_source_code,
+     get_json_object(resp_raw_data, '$.data.EventId') AS kyc_event_id,
+     get_json_object(resp_raw_data, '$.data.certificateIssued') AS kyc_status_raw,
+     CASE 
+         WHEN date(create_time) >= date('2024-03-21') THEN NULL
+         ELSE CASE 
+             WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+             WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+             ELSE NULL
+         END
+     END AS score_pob,
+     CASE 
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+         ELSE NULL
+     END AS score_full_name,
+     NULL AS score_address,
+     NULL AS score_province,
+     NULL AS score_city,
+     CASE 
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+         ELSE NULL
+     END AS score_dob,
+     NULL AS score_district,
+     NULL AS score_village,
+     CASE 
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+         ELSE NULL
+     END AS score_nik,
+     NULL AS score_mother_maiden_name,
+     NULL AS score_family_card_no,
+     CASE 
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+         ELSE NULL
+     END AS score_demographic,
+     CASE 
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+         ELSE NULL
+     END AS score_selfiephoto,
+     CAST(regexp_extract(resp_raw_data, '"field":"score_liveness","score":([0-9.]+)', 1) AS DECIMAL(10,2)) AS score_liveness,
+     trace_id AS trace_id,
+     create_time AS create_time,
+     update_time AS update_time,
+     current_date() AS grass_date
+ FROM
+     ods_risk.ods_risk_id_af_vida_di
+ WHERE
+     pt = '${PT}'
+     AND table_name = 'VidaLdnFull'
  
  
```

---

已完成VidaLdnFull.sql文件的编写。根据您提供的映射关系，我创建了一个完整的INSERT语句，将数据从ODS表(ods_risk.ods_risk_id_af_vida_di)导入到DWD表(risk.dwd_risk_id_af_vida_di)中。

SQL语句包含以下主要处理:
1. 对JSON格式数据(resp_raw_data)使用了get_json_object函数提取字段值
2. 实现了各个评分字段的条件逻辑计算
3. 对score_liveness字段使用了正则表达式提取
4. 添加了分区条件和表名过滤
5. 使用current_date()函数设置grass_date

如需调整任何字段的处理逻辑，请告知。

---

_**User**_

@VidaCfFull.sql 根据这个的代码结构改一下 VidaLdnFull这个文件的代码吧

---

_**Assistant**_



---

Read file: dwd_risk_id_af_vida_di/VidaLdnFull.sql

---

```diff
- -- 将 ODS 表中的 VidaCfFull 数据写入 DWD 表
+ -- 将 ODS 表中的 VidaLdnFull 数据写入 DWD 表
+ -- INSERT INTO TABLE risk.dwd_risk_id_af_vida_di
+ WITH exploded_fields AS (
+   SELECT 
+     resp_raw_data,
+     header_data,
+     request_key,
+     data_source_name,
+     data_source_code,
+     trace_id,
+     create_time,
+     update_time,
+     field_obj.field AS field_name,
+     field_obj.score AS field_score
+   FROM ods_risk.ods_risk_id_af_vida_di
+   LATERAL VIEW EXPLODE(
+     FROM_JSON(
+       get_json_object(resp_raw_data, '$.data.fields'),
+       'array<struct<field:string,score:double>>'
+     )
+   ) fields AS field_obj
+   WHERE table_name = 'VidaLdnFull' AND pt = '${PT}'
+ )
+ 
  INSERT INTO TABLE risk.dwd_risk_id_af_vida_di
  SELECT
-     header_data.credit_user_id AS credit_user_id,
-     request_key AS request_key,
-     data_source_name AS data_source_name,
-     data_source_code AS data_source_code,
-     get_json_object(resp_raw_data, '$.data.EventId') AS kyc_event_id,
-     get_json_object(resp_raw_data, '$.data.certificateIssued') AS kyc_status_raw,
+   get_json_object(t.header_data, '$.credit_user_id') AS credit_user_id,
+   t.request_key AS request_key,
+   t.data_source_name AS data_source_name,
+   t.data_source_code AS data_source_code,
+   get_json_object(t.resp_raw_data, '$.data.EventId') AS kyc_event_id,
+   get_json_object(t.resp_raw_data, '$.data.certificateIssued') AS kyc_status_raw,
+   -- 条件表达式处理字段
    CASE 
-         WHEN date(create_time) >= date('2024-03-21') THEN NULL
-         ELSE CASE 
-             WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
-             WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+     WHEN TO_DATE(t.create_time) >= TO_DATE('2024-03-21') THEN NULL
+     ELSE 
+       CASE 
+         WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+         WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
          ELSE NULL
        END
    END AS score_pob,
    CASE 
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
      ELSE NULL
    END AS score_full_name,
```

```diff
    NULL AS score_city,
    CASE 
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
      ELSE NULL
    END AS score_dob,
    NULL AS score_district,
    NULL AS score_village,
    CASE 
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
      ELSE NULL
    END AS score_nik,
    NULL AS score_mother_maiden_name,
    NULL AS score_family_card_no,
    CASE 
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
      ELSE NULL
    END AS score_demographic,
    CASE 
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
-         WHEN get_json_object(resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 200 THEN 10
+     WHEN get_json_object(t.resp_raw_data, '$.data.certificateIssued') = 444 THEN 0
      ELSE NULL
    END AS score_selfiephoto,
-     CAST(regexp_extract(resp_raw_data, '"field":"liveness","score":([0-9.]+)', 1) AS DECIMAL(10,2)) AS score_liveness,
-     trace_id AS trace_id,
-     create_time AS create_time,
-     update_time AS update_time,
-     current_date() AS grass_date
- FROM
-     ods_risk.ods_risk_id_af_vida_di
- WHERE
-     pt = '${PT}'
-     AND table_name = 'VidaLdnFull'
+   -- 处理score_liveness字段
+   MAX(CASE WHEN f.field_name = 'liveness' THEN f.field_score ELSE NULL END) AS score_liveness,
+   t.trace_id AS trace_id,
+   t.create_time AS create_time,
+   t.update_time AS update_time,
+   '${PT}' AS grass_date
+ FROM (
+   SELECT 
+     resp_raw_data,
+     header_data,
+     request_key,
+     data_source_name,
+     data_source_code,
+     trace_id,
+     create_time,
+     update_time
+   FROM ods_risk.ods_risk_id_af_vida_di
+   WHERE table_name = 'VidaLdnFull' AND pt = '${PT}'
+ ) t
+ LEFT JOIN exploded_fields f 
+ ON t.resp_raw_data = f.resp_raw_data
+ AND t.header_data = f.header_data
+ AND t.request_key = f.request_key
+ AND t.data_source_code = f.data_source_code
+ GROUP BY
+   t.resp_raw_data,
+   t.header_data,
+   t.request_key,
+   t.data_source_name,
+   t.data_source_code,
+   t.trace_id,
+   t.create_time,
+   t.update_time
+ ;
  
  
```

---

我已经根据VidaCfFull.sql的代码结构重写了VidaLdnFull.sql文件。主要变更包括：

1. 添加了CTE（公共表表达式）`exploded_fields`来解析JSON数据中的字段数组
2. 使用LATERAL VIEW EXPLODE从JSON中提取字段和分数
3. 修改了主查询，使用表别名t来引用子查询
4. 添加了LEFT JOIN连接主查询和CTE
5. 使用MAX函数处理score_liveness字段，通过field_name='liveness'条件提取对应的分数
6. 添加了GROUP BY子句对数据进行分组
7. 将草稿日期从current_date()更改为使用参数'${PT}'
8. 对所有字段引用添加了表前缀（例如t.resp_raw_data）
9. 将date函数替换为TO_DATE函数以保持一致性

这个结构更适合处理复杂的JSON数据结构，特别是对于需要展开JSON数组并提取特定字段的场景。

---

_**User**_

这两个 代码对比一下 差异 ，然后 给我 总结一下 他们的差异是什么 

---

_**Assistant**_



---

Read file: dwd_risk_id_af_vida_di/VidaLdnFull.sql

---



---

